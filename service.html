<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Planning Service - Grey Corner</title>
  <link rel="icon" type="image/jpeg" href="LOGO.jpg" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      /* ✅ Thème clair avec nuances PLUS contrastées */
      --bg:#f3f6ff;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#51607a;
      --line:rgba(11,18,32,.12);

      /* ✅ 2 couleurs principales (plus “creusées”) */
      --p1:#1d4ed8;   /* bleu plus profond */
      --p2:#0f766e;   /* teal plus profond */

      --shadow: 0 16px 44px rgba(11,18,32,.10);
      --radius:18px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      font-family:'Roboto',sans-serif;
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1200px 520px at 15% -10%, rgba(29,78,216,.20), transparent 55%),
        radial-gradient(1100px 520px at 100% 0%, rgba(15,118,110,.22), transparent 60%),
        linear-gradient(180deg, #ffffff, var(--bg) 55%, #ffffff);
      background-attachment: fixed;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* ✅ BANNIÈRE FIXE (claire, contrastée) */
    #alert-box{
      display:none;
      background: linear-gradient(90deg, rgba(29,78,216,.20), rgba(15,118,110,.22));
      border-bottom:1px solid var(--line);
      color: var(--ink);
      text-align:center;
      padding:12px 48px 12px 12px;
      font-weight:900;
      position:fixed; top:0; left:0; width:100%;
      z-index:9999;
      backdrop-filter: blur(12px);
    }
    body.has-alert{ padding-top:54px; }

    #alert-close{
      position:absolute;
      right:10px;
      top:50%;
      transform: translateY(-50%);
      border:none;
      background: rgba(11,18,32,0.10);
      color: var(--ink);
      font-weight:900;
      width:30px; height:30px;
      border-radius: 999px;
      cursor:pointer;
    }

    /* ✅ HEADER clair */
    header{
      padding: 18px 12px 14px;
      text-align:center;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,0.78);
      backdrop-filter: blur(12px);
      position: relative;
      z-index: 1;
    }

    .logo-img{
      width:60px; height:60px;
      border-radius:50%;
      border:2px solid rgba(29,78,216,.28);
      margin-bottom:10px;
      box-shadow: 0 12px 30px rgba(11,18,32,.10);
      object-fit: cover;
      background:#fff;
    }

    h1{
      font-family:'Playfair Display',serif;
      margin:0;
      font-size: 1.18rem;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      line-height: 1.2;
      background: linear-gradient(90deg, var(--p1), var(--p2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .sub{
      margin-top:6px;
      font-size:.82rem;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.3px;
    }

    .back-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      color: var(--ink);
      text-decoration:none;
      font-size:0.82rem;
      border:1px solid var(--line);
      padding:8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 24px rgba(11,18,32,.08);
    }
    .back-btn:active{ transform: scale(.99); }

    .container{
      width:100%;
      max-width: 640px;
      margin:0 auto;
      padding: 14px 12px 22px;
    }

    /* ✅ VIGNETTE JOUR: couleur rotative + contraste renforcé */
    .day-card{
      background: var(--card);
      margin-bottom: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      overflow:hidden;
      box-shadow: var(--shadow);
      position:relative;
    }

    /* bande latérale couleur (plus visible) */
    .day-card::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 12px;
      background: linear-gradient(180deg, var(--accent), rgba(255,255,255,.0));
      opacity: .98;
    }

    /* léger contour coloré */
    .day-card{
      outline: 2px solid rgba(0,0,0,0);
    }
    .day-card[data-colored="1"]{
      outline-color: var(--outline);
      outline-offset: -2px;
    }

    /* ✅ Jour J (encore plus mis en avant) */
    .is-today{
      border: 2px solid rgba(29,78,216,.40);
      box-shadow: 0 22px 54px rgba(29,78,216,.22);
      transform: translateY(-1px);
    }
    .is-today::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: radial-gradient(720px 240px at 22% 0%, rgba(29,78,216,.18), transparent 58%);
    }

    .card-header{
      padding: 14px 14px 12px 22px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(255,255,255,.94), rgba(255,255,255,.82)),
        radial-gradient(900px 260px at 30% 0%, var(--tint), transparent 55%);
    }
    .day-name{
      font-family:'Playfair Display',serif;
      font-size: 1.12rem;
      color: var(--ink);
      display:block;
      letter-spacing:.3px;
    }
    .today-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top: 10px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .72rem;
      font-weight: 1000;
      letter-spacing:.6px;
      color: var(--ink);
      background: linear-gradient(90deg, rgba(29,78,216,.20), rgba(15,118,110,.22));
      border:1px solid rgba(11,18,32,.12);
    }
    .today-dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 7px rgba(29,78,216,.14);
    }

    .card-body{ padding: 12px 12px 14px 22px; }

    /* ✅ 2 blocs shifts (Matin vs Soir) avec différences plus nettes */
    .shift-header{
      font-size: 0.78rem;
      font-weight: 1000;
      text-align:center;
      padding: 10px 10px;
      border-radius: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: .9px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.90);
      box-shadow: 0 10px 24px rgba(11,18,32,.08);
    }

    .shift-header.matin{
      background: linear-gradient(90deg, rgba(29,78,216,.22), rgba(255,255,255,.92));
      border-color: rgba(29,78,216,.32);
      color: #0b2a66;
    }

    .shift-header.soir{
      background: linear-gradient(90deg, rgba(15,118,110,.22), rgba(255,255,255,.92));
      border-color: rgba(15,118,110,.32);
      color: #064e47;
    }

    .shift-time{
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.2px;
    }

    .staff-row{
      display:flex;
      gap:10px;
      margin-bottom:10px;
      align-items:stretch;
    }

    .staff-name{
      flex: 1 1 auto;
      background: rgba(11,18,32,.045);
      color: var(--ink);
      font-weight: 1000;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.92rem;
      letter-spacing:.5px;
      padding: 12px 10px;
      border-radius: 14px;
      min-height:46px;
      border:1px solid rgba(11,18,32,.10);
    }

    .staff-poste{
      flex: 0 0 112px;
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.86));
      color: var(--ink);
      font-weight: 1000;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.78rem;
      letter-spacing:.6px;
      padding: 12px 10px;
      border-radius: 14px;
      min-height:46px;
      border:1px solid rgba(11,18,32,.12);
    }

    .repos{
      text-align:center;
      color: var(--muted);
      font-size:0.86rem;
      padding:12px 10px;
      font-weight: 1000;
      border:1px dashed rgba(11,18,32,.20);
      border-radius: 14px;
      background: rgba(255,255,255,.78);
    }

    @media (max-width: 420px){
      .container{ padding: 12px 10px 22px; }
      .logo-img{ width:56px; height:56px; }
      h1{ font-size: 1.08rem; }
      .day-name{ font-size: 1.06rem; }
      .staff-name{ font-size:0.90rem; }
      .staff-poste{ flex-basis: 104px; font-size:0.76rem; }
    }
  </style>
</head>

<body>
  <div id="alert-box">
    <span id="alert-text"></span>
    <button id="alert-close" type="button" onclick="hideAlert()">✕</button>
  </div>

  <!-- ✅ Suppression du bouton capture / footer flottant -->

  <div id="capture-zone">
    <header>
      <img src="LOGO.jpg" class="logo-img" onerror="this.src='https://via.placeholder.com/90?text=GC'">
      <h1>PLANNING SERVICE</h1>
      
      <a href="index.html" class="back-btn">⬅ Retour Menu</a>
    </header>

    <div class="container" id="planning-container">
      <div id="loading" style="text-align:center; padding:34px 10px; color:var(--muted); font-weight:1000;">
        Mise à jour du service...
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1aKrmu7Hdf1tb4_0QFCGC6VYjUVlRKeDJYLYs9qIM6Aw";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

    const DEFAULT_H_MATIN = "09:00 - 16:00";
    const DEFAULT_H_SOIR  = "16:00 - Fin service";

    /* ✅ Rotation: nuances plus “creusées” (accent + tint + outline) */
    const ROTATION = [
      { accent:"#1d4ed8", tint:"rgba(29,78,216,.22)", outline:"rgba(29,78,216,.22)" }, // bleu
      { accent:"#0f766e", tint:"rgba(15,118,110,.24)", outline:"rgba(15,118,110,.22)" }, // teal
      { accent:"#b45309", tint:"rgba(180,83,9,.18)", outline:"rgba(180,83,9,.18)" }, // amber profond
      { accent:"#7c3aed", tint:"rgba(124,58,237,.18)", outline:"rgba(124,58,237,.18)" }, // violet profond
      { accent:"#be123c", tint:"rgba(190,18,60,.16)", outline:"rgba(190,18,60,.16)" }, // rose/rouge profond
      { accent:"#15803d", tint:"rgba(21,128,61,.16)", outline:"rgba(21,128,61,.16)" }  // vert profond
    ];

    function showAlert(msg){
      const box = document.getElementById("alert-box");
      const textEl = document.getElementById("alert-text");
      if(!box || !textEl) return;
      textEl.textContent = msg;
      box.style.display = "block";
      document.body.classList.add("has-alert");
    }

    function hideAlert(){
      const box = document.getElementById("alert-box");
      if(!box) return;
      box.style.display = "none";
      document.body.classList.remove("has-alert");
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function isHtml(text){
      return /<html[\s>]/i.test(text) || /<!doctype html/i.test(text);
    }

    function splitCsvLine(line){
      return line
        .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
        .map(c => c.replace(/^"|"$/g,"").trim());
    }

    function cleanPoste(raw){
      if(!raw) return "";
      const p = String(raw).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
      if(p.includes("loge")) return "LOGE";
      if(p.includes("ter1")) return "TER1";
      if(p.includes("ter2")) return "TER2";
      if(p.includes("ter3")) return "TER3";
      if(p.includes("terrasse") || p.includes("ter")) return "TER";
      if(p.includes("sala2")) return "SAL2";
      if(p.includes("sala1") || p.includes("sala") || p === "sal") return "SAL";
      if(p.includes("bar")) return "BAR";
      if(p.includes("caisse")) return "CAIS";
      if(p.includes("run")) return "RUN";
      if(p.includes("acc")) return "ACC";
      if(p.includes("deb")) return "DEB";
      return String(raw).substring(0,4).toUpperCase();
    }

    function pickTime(raw, fallback){
      const t = String(raw ?? "").trim();
      return (t && t !== "-") ? t : fallback;
    }

    function todayMidnight(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d;
    }

    function parseDateLabel(label){
      const s0 = String(label ?? "").trim();
      if(!s0) return null;

      // ISO: 2026-02-22 ou 2026/02/22
      let m = s0.match(/\b(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})\b/);
      if(m){
        const y = +m[1], mo = +m[2]-1, da = +m[3];
        const d = new Date(y, mo, da);
        d.setHours(0,0,0,0);
        return isNaN(d) ? null : d;
      }

      // FR numérique: 22/02/2026 ou 22-02-2026
      m = s0.match(/\b(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})\b/);
      if(m){
        const da = +m[1], mo = +m[2]-1, y = +m[3];
        const d = new Date(y, mo, da);
        d.setHours(0,0,0,0);
        return isNaN(d) ? null : d;
      }

      // Texte FR: "dimanche 22 février 2026" ou "22 février"
      const months = {
        "janvier":0,"fevrier":1,"février":1,"mars":2,"avril":3,"mai":4,"juin":5,
        "juillet":6,"aout":7,"août":7,"septembre":8,"octobre":9,"novembre":10,
        "decembre":11,"décembre":11
      };

      const low = s0.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      m = low.match(/\b(\d{1,2})\s+(janvier|fevrier|mars|avril|mai|juin|juillet|aout|septembre|octobre|novembre|decembre)\b(?:\s+(\d{4}))?/);
      if(m){
        const da = +m[1];
        const mo = months[m[2]];
        const y = m[3] ? +m[3] : (new Date()).getFullYear();
        const d = new Date(y, mo, da);
        d.setHours(0,0,0,0);
        return isNaN(d) ? null : d;
      }

      return null;
    }

    function sameDay(a,b){
      return a && b &&
        a.getFullYear()===b.getFullYear() &&
        a.getMonth()===b.getMonth() &&
        a.getDate()===b.getDate();
    }

    async function init(){
      const loadingEl = document.getElementById("loading");
      try{
        const resp = await fetch(SHEET_URL, { cache:"no-store" });
        const text = await resp.text();

        if(isHtml(text)){
          if(loadingEl) loadingEl.innerText = "Accès refusé : la feuille n'est pas publique.";
          showAlert("Google Sheet non public. Partage: 'toute personne avec le lien'.");
          return;
        }

        const rows = text
          .split(/\r?\n/)
          .map(r => r.replace(/\r/g,"").trim())
          .filter(r => r.length);

        if(rows.length <= 1){
          if(loadingEl) loadingEl.innerText = "Aucune donnée trouvée.";
          return;
        }

        /* ✅ BANNIÈRE FIXE = D2 */
        let bannerD2 = "";
        if(rows.length >= 2){
          const colsRow2 = splitCsvLine(rows[1]);
          bannerD2 = String(colsRow2[3] ?? "").trim();
        }
        if(bannerD2 && bannerD2 !== "-") showAlert(bannerD2);

        const all = [];
        for(let i=1;i<rows.length;i++){
          const cols = splitCsvLine(rows[i]);
          if(cols.length >= 3 && cols[0] !== ""){
            const d = parseDateLabel(cols[0]);
            all.push({
              date: cols[0],
              dateObj: d,
              matin: cols[1] ?? "",
              soir:  cols[2] ?? "",
              msg:   cols[3] ?? "",
              hMatin: cols[4] ?? "",
              hSoir:  cols[5] ?? ""
            });
          }
        }

        const t0 = todayMidnight();
        const anyParsable = all.some(r => r.dateObj instanceof Date);

        let data = all;
        let hasToday = false;

        if(anyParsable){
          data = all.filter(r => r.dateObj && r.dateObj >= t0);  // ✅ cache anciens
          hasToday = data.some(r => sameDay(r.dateObj, t0));
        }else{
          showAlert("Format date non reconnu: mets A en 2026-02-22 ou 22/02/2026.");
        }

        render(data, hasToday, t0);

      }catch(e){
        if(loadingEl) loadingEl.innerText = "Erreur de chargement";
      }
    }

    function render(data, hasToday, t0){
      const container = document.getElementById("planning-container");
      const loadingEl = document.getElementById("loading");
      if(loadingEl) loadingEl.remove();

      if(!data.length){
        container.innerHTML = `<div style="text-align:center; padding:28px 10px; color:var(--muted); font-weight:1000;">
          Aucun jour à afficher (anciennes dates cachées).
        </div>`;
        return;
      }

      let todayIndex = -1;
      for(let i=0;i<data.length;i++){
        if(data[i].dateObj && sameDay(data[i].dateObj, t0)){ todayIndex = i; break; }
      }

      container.innerHTML = data.map((j, idx) => {
        const isToday = (todayIndex >= 0 && idx === todayIndex);
        const hMatin = pickTime(j.hMatin, DEFAULT_H_MATIN);
        const hSoir  = pickTime(j.hSoir,  DEFAULT_H_SOIR);

        const rot = ROTATION[idx % ROTATION.length];

        return `
          <div class="day-card ${isToday ? 'is-today' : ''}"
               data-colored="1"
               style="--accent:${rot.accent}; --tint:${rot.tint}; --outline:${rot.outline};"
               ${isToday ? 'id="today-card"' : ''}>
            <div class="card-header">
              <span class="day-name">${escapeHtml(j.date)}</span>
              ${isToday ? `<div class="today-badge"><span class="today-dot"></span>JOUR J</div>` : ``}
            </div>

            <div class="card-body">
              <div class="shift-header matin">
                MATIN <span class="shift-time">(${escapeHtml(hMatin)})</span>
              </div>
              ${parseStaff(j.matin)}

              <div class="shift-header soir" style="margin-top:16px;">
                SOIR <span class="shift-time">(${escapeHtml(hSoir)})</span>
              </div>
              ${parseStaff(j.soir)}
            </div>
          </div>
        `;
      }).join("");

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const el = document.getElementById("today-card");
          if(el) el.scrollIntoView({ behavior:"smooth", block:"start" });
        });
      });
    }

    function parseStaff(t){
      if(!t || t === "-" || t.trim() === ""){
        return `<div class="repos">REPOS</div>`;
      }

      return t.split(",").map(s => {
        let name = "";
        let poste = "";
        s = s.trim();

        if(s.includes(":")){
          const parts = s.split(":");
          poste = cleanPoste(parts[0]);
          name = parts.slice(1).join(":").trim();
        }else if(s.includes("(") && s.includes(")")){
          name = s.substring(0, s.indexOf("(")).trim();
          poste = cleanPoste(s.substring(s.indexOf("(")+1, s.lastIndexOf(")")));
        }else{
          name = s;
          poste = "";
        }

        return `
          <div class="staff-row">
            <div class="staff-name">${escapeHtml(name)}</div>
            <div class="staff-poste">${escapeHtml(poste)}</div>
          </div>
        `;
      }).join("");
    }

    init();
  </script>
</body>
</html>