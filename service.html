<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Planning Service - Grey Corner</title>
  <link rel="icon" type="image/jpeg" href="LOGO.jpg" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root { --gold:#D4AF37; --night:#0B0E14; --card-bg:#1A1F26; }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      font-family:'Roboto',sans-serif;
      background: radial-gradient(circle at top,#1a2a6c 0%, var(--night) 100%);
      background-attachment: fixed;
      margin:0; color:#fff;
      padding-bottom: 92px;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
    }

    #alert-box{
      display:none;
      background: linear-gradient(to right, #d4af37, #f1c40f);
      color:#000; text-align:center; padding:12px; font-weight:900;
      position:fixed; top:0; left:0; width:100%; z-index:9999;
    }
    body.has-alert{ padding-top:45px; }

    header{
      padding: 18px 12px;
      text-align:center;
      border-bottom: 1px solid rgba(212,175,55,0.35);
      background: rgba(0,0,0,0.18);
      position: sticky;
      top:0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }
    .logo-img{ width:58px; height:58px; border-radius:50%; border:2px solid var(--gold); margin-bottom:8px; }
    h1{
      font-family:'Playfair Display',serif;
      margin:0;
      font-size: 1.15rem;
      color: var(--gold);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      line-height: 1.2;
    }
    .back-btn{
      display:inline-block; margin-top:10px; color:var(--gold); text-decoration:none;
      font-size:0.78rem; border:1px solid rgba(212,175,55,0.85);
      padding:7px 14px; border-radius: 999px;
    }

    .container{
      width:100%;
      max-width: 560px;
      margin:0 auto;
      padding: 14px 12px 20px;
    }

    .day-card{
      background: var(--card-bg);
      margin-bottom: 14px;
      border-radius: 14px;
      border: 1px solid rgba(212,175,55,0.18);
      overflow:hidden;
      scroll-margin-top: 96px; /* pour scroll sous header sticky */
    }
    .card-header{
      background: rgba(255,255,255,0.03);
      padding: 12px;
      text-align:center;
      border-bottom: 1px solid rgba(212,175,55,0.10);
    }
    .day-name{
      font-family:'Playfair Display',serif;
      font-size: 1.15rem;
      color: var(--gold);
      display:block;
    }
    .today-badge{
      background: var(--gold);
      color:#000;
      font-size: 0.70rem;
      font-weight: 900;
      padding: 4px 12px;
      border-radius: 999px;
      margin-top: 8px;
      display:inline-block;
    }
    .is-today{
      border: 2px solid rgba(212,175,55,0.9);
      box-shadow: 0 6px 18px rgba(212,175,55,0.18);
    }

    .card-body{ padding: 12px; }
    .shift-header{
      color: var(--gold);
      font-size: 0.78rem;
      font-weight: 900;
      text-align:center;
      padding: 8px;
      border: 1px solid rgba(212,175,55,0.20);
      border-radius: 10px;
      margin-bottom: 10px;
      background: rgba(212,175,55,0.05);
      text-transform: uppercase;
      letter-spacing: .8px;
    }

    /* --- LIGNES STAFF: NOM JAUNE / POSTE GRIS --- */
    .staff-row{
      display:flex;
      margin-bottom:8px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
      min-height:44px;
    }

    /* NOM (jaune √† gauche) */
    .staff-name{
      width:65%;
      background:var(--gold);
      color:#000;
      font-weight:900;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.92rem;
      letter-spacing:.5px;
      padding: 10px 8px;
    }

    /* POSTE (gris √† droite) */
    .staff-poste{
      width:35%;
      background:rgba(255,255,255,0.12);
      color:#fff;
      font-weight:900;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.78rem;
      letter-spacing:.6px;
      padding: 10px 8px;
    }

    .fab-btn{
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: var(--gold);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 22px rgba(0,0,0,0.55);
      font-size: 22px;
      cursor:pointer;
      z-index: 200;
      border:none;
    }
    .fab-btn:active{ transform: scale(0.98); }

    @media (max-width: 420px){
      .container{ padding: 12px 10px 20px; }
      .logo-img{ width:54px; height:54px; }
      h1{ font-size: 1.05rem; }
      .day-name{ font-size: 1.08rem; }
      .staff-name{ width:66%; font-size:0.90rem; }
      .staff-poste{ width:34%; font-size:0.76rem; }
      .fab-btn{ width:54px; height:54px; right:14px; bottom:14px; }
    }
  </style>
</head>

<body>
  <div id="alert-box"></div>
  <button class="fab-btn" onclick="downloadPlanning()">üì∏</button>

  <div id="capture-zone">
    <header>
      <img src="LOGO.jpg" class="logo-img" onerror="this.src='https://via.placeholder.com/90?text=GC'">
      <h1>PLANNING SERVICE</h1>
      <a href="index.html" class="back-btn" data-html2canvas-ignore="true">‚¨Ö Retour Menu</a>
    </header>

    <div class="container" id="planning-container">
      <div id="loading" style="text-align:center; padding:34px 10px; color:var(--gold); font-weight:900;">
        Mise √† jour du service...
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1aKrmu7Hdf1tb4_0QFCGC6VYjUVlRKeDJYLYs9qIM6Aw";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

    function showAlert(msg){
      const box = document.getElementById("alert-box");
      if(!box) return;
      box.textContent = msg;
      box.style.display = "block";
      document.body.classList.add("has-alert");
      setTimeout(() => {
        box.style.display = "none";
        document.body.classList.remove("has-alert");
      }, 4200);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalize(str){
      return String(str ?? "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ")
        .trim();
    }

    function isHtml(text){
      return /<html[\s>]/i.test(text) || /<!doctype html/i.test(text);
    }

    function getTodayInfo(){
      const now = new Date();
      const day = now.getDate();
      const weekday = normalize(new Intl.DateTimeFormat("fr-FR", { weekday: "long" }).format(now));
      const month   = normalize(new Intl.DateTimeFormat("fr-FR", { month: "long" }).format(now));
      return { day, weekday, month };
    }

    // d√©tecte la premi√®re ligne qui correspond √† aujourd'hui (jour+ (jour-semaine OU mois))
    function rowLooksLikeToday(label, todayInfo){
      const s = normalize(label);
      if(!s) return false;

      const hasDayNum = new RegExp(`\\b${todayInfo.day}\\b`).test(s);
      if(!hasDayNum) return false;

      const hasWeekday = s.includes(todayInfo.weekday);
      const hasMonth   = s.includes(todayInfo.month);

      return hasWeekday || hasMonth;
    }

    function splitCsvLine(line){
      return line
        .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
        .map(c => c.replace(/^"|"$/g,"").trim());
    }

    // POSTE -> code court (LOGE, SAL, TER...)
    function cleanPoste(raw){
      if(!raw) return "";
      const p = String(raw).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();

      if(p.includes("loge")) return "LOGE";
      if(p.includes("ter1")) return "TER1";
      if(p.includes("ter2")) return "TER2";
      if(p.includes("terrasse") || p.includes("ter")) return "TER";
      if(p.includes("sala2")) return "SAL2";
      if(p.includes("sala1") || p.includes("sala") || p === "sal") return "SAL";
      if(p.includes("bar")) return "BAR";
      if(p.includes("caisse")) return "CAIS";
      if(p.includes("run")) return "RUN";
      if(p.includes("acc")) return "ACC";

      return String(raw).substring(0,4).toUpperCase();
    }

    async function init(){
      const loadingEl = document.getElementById("loading");
      try{
        const resp = await fetch(SHEET_URL, { cache:"no-store" });
        const text = await resp.text();

        if(isHtml(text)){
          if(loadingEl) loadingEl.innerText = "Acc√®s refus√© : la feuille n'est pas publique.";
          showAlert("Google Sheet non public. Partage: 'toute personne avec le lien'.");
          return;
        }

        const rows = text
          .split(/\r?\n/)
          .map(r => r.replace(/\r/g,"").trim())
          .filter(r => r.length);

        if(rows.length <= 1){
          if(loadingEl) loadingEl.innerText = "Aucune donn√©e trouv√©e.";
          return;
        }

        const todayInfo = getTodayInfo();

        const all = [];
        for(let i=1;i<rows.length;i++){
          const cols = splitCsvLine(rows[i]);
          if(cols.length >= 3 && cols[0] !== ""){
            all.push({ date: cols[0], matin: cols[1], soir: cols[2] });
          }
        }

        // ‚úÖ Masquage: on coupe √† partir de "aujourd'hui"
        const startIndex = all.findIndex(r => rowLooksLikeToday(r.date, todayInfo));
        let data = all;
        let hasToday = false;

        if(startIndex >= 0){
          data = all.slice(startIndex);
          hasToday = true;
        }else{
          showAlert("Aujourd'hui non trouv√© dans la feuille (format date diff√©rent).");
        }

        render(data, hasToday);

      }catch(e){
        if(loadingEl) loadingEl.innerText = "Erreur de chargement";
      }
    }

    function render(data, hasToday){
      const container = document.getElementById("planning-container");
      const loadingEl = document.getElementById("loading");
      if(loadingEl) loadingEl.remove();

      if(!data.length){
        container.innerHTML = `<div style="text-align:center; opacity:0.9; padding:28px 10px; color:var(--gold); font-weight:900;">
          Aucun jour √† afficher.
        </div>`;
        return;
      }

      container.innerHTML = data.map((j, idx) => {
        const isToday = hasToday && idx === 0; // apr√®s slicing, aujourd'hui = 1√®re carte
        return `
          <div class="day-card ${isToday ? 'is-today' : ''}" ${isToday ? 'id="today-card"' : ''}>
            <div class="card-header">
              <span class="day-name">${escapeHtml(j.date)}</span>
              ${isToday ? `<div class="today-badge">AUJOURD'HUI</div>` : ``}
            </div>
            <div class="card-body">
              <div class="shift-header">MATIN</div>
              ${parseStaff(j.matin)}
              <div class="shift-header" style="margin-top:16px;">SOIR</div>
              ${parseStaff(j.soir)}
            </div>
          </div>
        `;
      }).join("");

      // ‚úÖ Scroll fiable vers aujourd'hui
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const el = document.getElementById("today-card");
          if(el){
            el.scrollIntoView({ behavior:"smooth", block:"start" });
            setTimeout(() => window.scrollBy({ top: -10, left: 0, behavior: "smooth" }), 250);
          }
        });
      });
    }

    function parseStaff(t){
      if(!t || t === "-" || t.trim() === ""){
        return `<div style="text-align:center; opacity:0.35; font-size:0.85rem; padding:10px; font-weight:900;">REPOS</div>`;
      }

      // Format attendu: "POSTE: NOM, POSTE: NOM, ..."
      // Si pas de ":", alors poste vide (case grise vide).
      return t.split(",").map(s => {
        let name = s.trim();
        let poste = "";

        if(s.includes(":")){
          const parts = s.split(":");
          poste = cleanPoste(parts[0]);
          name = parts.slice(1).join(":").trim();
        }

        return `
          <div class="staff-row">
            <div class="staff-name">${escapeHtml(name)}</div>
            <div class="staff-poste">${escapeHtml(poste)}</div>
          </div>
        `;
      }).join("");
    }

    function downloadPlanning(){
      html2canvas(document.getElementById("capture-zone"), {
        scale: 2,
        backgroundColor: "#0B0E14",
        useCORS: true,
        allowTaint: false
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = "Planning-Service.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      }).catch(() => {
        showAlert("Capture impossible (CORS / images externes).");
      });
    }

    init();
  </script>
</body>
</html>