<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Planning Service - Grey Corner</title>
  <link rel="icon" type="image/jpeg" href="LOGO.jpg" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      /* âœ… ThÃ¨me clair 2 couleurs + neutres */
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);

      /* âœ… 2 couleurs principales */
      --p1:#2563eb;   /* bleu */
      --p2:#14b8a6;   /* teal */

      --shadow: 0 14px 40px rgba(15,23,42,.08);
      --radius:18px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      font-family:'Roboto',sans-serif;
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1200px 520px at 20% -10%, rgba(37,99,235,.14), transparent 55%),
        radial-gradient(1100px 520px at 100% 0%, rgba(20,184,166,.16), transparent 60%),
        linear-gradient(180deg, #ffffff, var(--bg) 55%, #ffffff);
      background-attachment: fixed;
      padding-bottom: 96px;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* âœ… BANNIÃˆRE FIXE (claire) */
    #alert-box{
      display:none;
      background: linear-gradient(90deg, rgba(37,99,235,.16), rgba(20,184,166,.18));
      border-bottom:1px solid var(--line);
      color: var(--ink);
      text-align:center;
      padding:12px 48px 12px 12px;
      font-weight:900;
      position:fixed; top:0; left:0; width:100%;
      z-index:9999;
      backdrop-filter: blur(10px);
    }
    body.has-alert{ padding-top:54px; }

    #alert-close{
      position:absolute;
      right:10px;
      top:50%;
      transform: translateY(-50%);
      border:none;
      background: rgba(15,23,42,0.08);
      color: var(--ink);
      font-weight:900;
      width:30px; height:30px;
      border-radius: 999px;
      cursor:pointer;
    }

    /* âœ… HEADER clair */
    header{
      padding: 18px 12px 14px;
      text-align:center;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }

    .logo-img{
      width:60px; height:60px;
      border-radius:50%;
      border:2px solid rgba(37,99,235,.25);
      margin-bottom:10px;
      box-shadow: 0 10px 26px rgba(15,23,42,.08);
      object-fit: cover;
      background:#fff;
    }
    h1{
      font-family:'Playfair Display',serif;
      margin:0;
      font-size: 1.18rem;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      line-height: 1.2;
      background: linear-gradient(90deg, var(--p1), var(--p2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .sub{
      margin-top:6px;
      font-size:.82rem;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.3px;
    }

    .back-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      color: var(--ink);
      text-decoration:none;
      font-size:0.82rem;
      border:1px solid var(--line);
      padding:8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .back-btn:active{ transform: scale(.99); }

    .container{
      width:100%;
      max-width: 640px;
      margin:0 auto;
      padding: 14px 12px 22px;
    }

    /* âœ… VIGNETTE JOUR: couleur rotative via CSS variables --accent / --tint */
    .day-card{
      background: var(--card);
      margin-bottom: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      overflow:hidden;
      box-shadow: var(--shadow);
      scroll-margin-top: 0;
      position:relative;
    }

    /* bande latÃ©rale couleur */
    .day-card::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 10px;
      background: linear-gradient(180deg, var(--accent), rgba(255,255,255,.0));
      opacity:.95;
    }

    /* âœ… Mise en avant Jour J */
    .is-today{
      border: 2px solid rgba(37,99,235,.35);
      box-shadow: 0 18px 46px rgba(37,99,235,.18);
      transform: translateY(-1px);
    }
    .is-today::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: radial-gradient(700px 220px at 25% 0%, rgba(37,99,235,.14), transparent 55%);
    }

    .card-header{
      padding: 14px 14px 12px 20px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(255,255,255,.92), rgba(255,255,255,.75)),
        radial-gradient(900px 240px at 30% 0%, var(--tint), transparent 55%);
    }
    .day-name{
      font-family:'Playfair Display',serif;
      font-size: 1.12rem;
      color: var(--ink);
      display:block;
      letter-spacing:.3px;
    }
    .today-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top: 10px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .72rem;
      font-weight: 1000;
      letter-spacing:.6px;
      color: var(--ink);
      background: linear-gradient(90deg, rgba(37,99,235,.16), rgba(20,184,166,.18));
      border:1px solid rgba(15,23,42,.10);
    }
    .today-dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(37,99,235,.12);
    }

    .card-body{ padding: 12px 12px 14px 20px; }

    /* âœ… 2 blocs shifts (Matin = bleu clair, Soir = teal clair) */
    .shift-header{
      font-size: 0.78rem;
      font-weight: 1000;
      text-align:center;
      padding: 10px 10px;
      border-radius: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: .9px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .shift-header.matin{
      background: linear-gradient(90deg, rgba(37,99,235,.12), rgba(255,255,255,.85));
      border-color: rgba(37,99,235,.22);
      color: #0b2a66;
    }
    .shift-header.soir{
      background: linear-gradient(90deg, rgba(20,184,166,.12), rgba(255,255,255,.85));
      border-color: rgba(20,184,166,.22);
      color: #064e47;
    }
    .shift-time{
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.2px;
    }

    .staff-row{
      display:flex;
      gap:10px;
      margin-bottom:10px;
      align-items:stretch;
    }

    .staff-name{
      flex: 1 1 auto;
      background: rgba(15,23,42,.04);
      color: var(--ink);
      font-weight: 1000;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.92rem;
      letter-spacing:.5px;
      padding: 12px 10px;
      border-radius: 14px;
      min-height:46px;
      border:1px solid rgba(15,23,42,.08);
    }

    .staff-poste{
      flex: 0 0 112px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.80));
      color: var(--ink);
      font-weight: 1000;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.78rem;
      letter-spacing:.6px;
      padding: 12px 10px;
      border-radius: 14px;
      min-height:46px;
      border:1px solid rgba(15,23,42,.10);
    }

    .repos{
      text-align:center;
      color: var(--muted);
      font-size:0.86rem;
      padding:12px 10px;
      font-weight: 1000;
      border:1px dashed rgba(15,23,42,.16);
      border-radius: 14px;
      background: rgba(255,255,255,.70);
    }

    /* âœ… Bouton capture (clair) */
    .fab-btn{
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: linear-gradient(135deg, var(--p1), var(--p2));
      width: 58px;
      height: 58px;
      border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 16px 40px rgba(15,23,42,.20);
      font-size: 22px;
      cursor:pointer;
      z-index: 200;
      border:none;
      color:#fff;
    }
    .fab-btn:active{ transform: scale(0.98); }

    @media (max-width: 420px){
      .container{ padding: 12px 10px 22px; }
      .logo-img{ width:56px; height:56px; }
      h1{ font-size: 1.08rem; }
      .day-name{ font-size: 1.06rem; }
      .staff-name{ font-size:0.90rem; }
      .staff-poste{ flex-basis: 104px; font-size:0.76rem; }
      .fab-btn{ width:56px; height:56px; right:14px; bottom:14px; }
    }
  </style>
</head>

<body>
  <div id="alert-box">
    <span id="alert-text"></span>
    <button id="alert-close" type="button" onclick="hideAlert()">âœ•</button>
  </div>

  <button class="fab-btn" onclick="downloadPlanning()" title="TÃ©lÃ©charger">ðŸ“¸</button>

  <div id="capture-zone">
    <header>
      <img src="LOGO.jpg" class="logo-img" onerror="this.src='https://via.placeholder.com/90?text=GC'">
      <h1>PLANNING SERVICE</h1>
      <div class="sub">ThÃ¨me clair â€¢ Rotation couleurs â€¢ Jour J mis en avant</div>
      <a href="index.html" class="back-btn" data-html2canvas-ignore="true">â¬… Retour Menu</a>
    </header>

    <div class="container" id="planning-container">
      <div id="loading" style="text-align:center; padding:34px 10px; color:var(--muted); font-weight:1000;">
        Mise Ã  jour du service...
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1aKrmu7Hdf1tb4_0QFCGC6VYjUVlRKeDJYLYs9qIM6Aw";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

    /* âœ… Par dÃ©faut si E/F vides */
    const DEFAULT_H_MATIN = "09:00 - 16:00";
    const DEFAULT_H_SOIR  = "16:00 - Fin service";

    /* âœ… Palette rotation (chaque jour une couleur) */
    const ROTATION = [
      { accent: "#2563eb", tint: "rgba(37,99,235,.16)" },   // bleu
      { accent: "#14b8a6", tint: "rgba(20,184,166,.18)" },  // teal
      { accent: "#f59e0b", tint: "rgba(245,158,11,.18)" },  // amber
      { accent: "#a855f7", tint: "rgba(168,85,247,.16)" },  // violet
      { accent: "#ef4444", tint: "rgba(239,68,68,.14)" },   // rouge doux
      { accent: "#22c55e", tint: "rgba(34,197,94,.16)" }    // vert
    ];

    function showAlert(msg){
      const box = document.getElementById("alert-box");
      const textEl = document.getElementById("alert-text");
      if(!box || !textEl) return;
      textEl.textContent = msg;
      box.style.display = "block";
      document.body.classList.add("has-alert");
    }

    function hideAlert(){
      const box = document.getElementById("alert-box");
      if(!box) return;
      box.style.display = "none";
      document.body.classList.remove("has-alert");
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalize(str){
      return String(str ?? "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ")
        .trim();
    }

    function isHtml(text){
      return /<html[\s>]/i.test(text) || /<!doctype html/i.test(text);
    }

    function getTodayInfo(){
      const now = new Date();
      const day = now.getDate();
      const weekday = normalize(new Intl.DateTimeFormat("fr-FR", { weekday: "long" }).format(now));
      const month   = normalize(new Intl.DateTimeFormat("fr-FR", { month: "long" }).format(now));
      return { day, weekday, month };
    }

    function rowLooksLikeToday(label, todayInfo){
      const s = normalize(label);
      if(!s) return false;

      const hasDayNum = new RegExp(`\\b${todayInfo.day}\\b`).test(s);
      if(!hasDayNum) return false;

      return s.includes(todayInfo.weekday) || s.includes(todayInfo.month);
    }

    function splitCsvLine(line){
      return line
        .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
        .map(c => c.replace(/^"|"$/g,"").trim());
    }

    function cleanPoste(raw){
      if(!raw) return "";
      const p = String(raw).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();

      if(p.includes("loge")) return "LOGE";
      if(p.includes("ter1")) return "TER1";
      if(p.includes("ter2")) return "TER2";
      if(p.includes("ter3")) return "TER3";
      if(p.includes("terrasse") || p.includes("ter")) return "TER";
      if(p.includes("sala2")) return "SAL2";
      if(p.includes("sala1") || p.includes("sala") || p === "sal") return "SAL";
      if(p.includes("bar")) return "BAR";
      if(p.includes("caisse")) return "CAIS";
      if(p.includes("run")) return "RUN";
      if(p.includes("acc")) return "ACC";
      if(p.includes("deb")) return "DEB";

      return String(raw).substring(0,4).toUpperCase();
    }

    function pickTime(raw, fallback){
      const t = String(raw ?? "").trim();
      return (t && t !== "-") ? t : fallback;
    }

    async function init(){
      const loadingEl = document.getElementById("loading");
      try{
        const resp = await fetch(SHEET_URL, { cache:"no-store" });
        const text = await resp.text();

        if(isHtml(text)){
          if(loadingEl) loadingEl.innerText = "AccÃ¨s refusÃ© : la feuille n'est pas publique.";
          showAlert("Google Sheet non public. Partage: 'toute personne avec le lien'.");
          return;
        }

        const rows = text
          .split(/\r?\n/)
          .map(r => r.replace(/\r/g,"").trim())
          .filter(r => r.length);

        if(rows.length <= 1){
          if(loadingEl) loadingEl.innerText = "Aucune donnÃ©e trouvÃ©e.";
          return;
        }

        const todayInfo = getTodayInfo();

        /* âœ… BANNIÃˆRE FIXE = D2 */
        let bannerD2 = "";
        if(rows.length >= 2){
          const colsRow2 = splitCsvLine(rows[1]);
          bannerD2 = String(colsRow2[3] ?? "").trim();
        }
        if(bannerD2 && bannerD2 !== "-") showAlert(bannerD2);

        /* âœ… Lecture: A,B,C,D,E,F */
        const all = [];
        for(let i=1;i<rows.length;i++){
          const cols = splitCsvLine(rows[i]);
          if(cols.length >= 3 && cols[0] !== ""){
            all.push({
              date: cols[0],
              matin: cols[1] ?? "",
              soir:  cols[2] ?? "",
              msg:   cols[3] ?? "",
              hMatin: cols[4] ?? "",
              hSoir:  cols[5] ?? ""
            });
          }
        }

        /* âœ… Cacher anciennes dates: on dÃ©marre Ã  la ligne qui correspond au Jour J */
        const startIndex = all.findIndex(r => rowLooksLikeToday(r.date, todayInfo));
        let data = all;
        let hasToday = false;

        if(startIndex >= 0){
          data = all.slice(startIndex);  // âœ… anciens jours cachÃ©s
          hasToday = true;
        }else{
          if(!bannerD2) showAlert("Aujourd'hui non trouvÃ© dans la feuille (format date diffÃ©rent).");
        }

        render(data, hasToday);

      }catch(e){
        if(loadingEl) loadingEl.innerText = "Erreur de chargement";
      }
    }

    function render(data, hasToday){
      const container = document.getElementById("planning-container");
      const loadingEl = document.getElementById("loading");
      if(loadingEl) loadingEl.remove();

      if(!data.length){
        container.innerHTML = `<div style="text-align:center; padding:28px 10px; color:var(--muted); font-weight:1000;">
          Aucun jour Ã  afficher.
        </div>`;
        return;
      }

      container.innerHTML = data.map((j, idx) => {
        const isToday = hasToday && idx === 0;
        const hMatin = pickTime(j.hMatin, DEFAULT_H_MATIN);
        const hSoir  = pickTime(j.hSoir,  DEFAULT_H_SOIR);

        const rot = ROTATION[idx % ROTATION.length];

        return `
          <div class="day-card ${isToday ? 'is-today' : ''}"
               style="--accent:${rot.accent}; --tint:${rot.tint};"
               ${isToday ? 'id="today-card"' : ''}>
            <div class="card-header">
              <span class="day-name">${escapeHtml(j.date)}</span>
              ${isToday ? `<div class="today-badge"><span class="today-dot"></span>JOUR J</div>` : ``}
            </div>

            <div class="card-body">
              <div class="shift-header matin">
                MATIN <span class="shift-time">(${escapeHtml(hMatin)})</span>
              </div>
              ${parseStaff(j.matin)}

              <div class="shift-header soir" style="margin-top:16px;">
                SOIR <span class="shift-time">(${escapeHtml(hSoir)})</span>
              </div>
              ${parseStaff(j.soir)}
            </div>
          </div>
        `;
      }).join("");

      /* âœ… Pointer sur le jour J */
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const el = document.getElementById("today-card");
          if(el) el.scrollIntoView({ behavior:"smooth", block:"start" });
        });
      });
    }

    function parseStaff(t){
      if(!t || t === "-" || t.trim() === ""){
        return `<div class="repos">REPOS</div>`;
      }

      return t.split(",").map(s => {
        let name = "";
        let poste = "";
        s = s.trim();

        if(s.includes(":")){
          const parts = s.split(":");
          poste = cleanPoste(parts[0]);
          name = parts.slice(1).join(":").trim();
        }else if(s.includes("(") && s.includes(")")){
          name = s.substring(0, s.indexOf("(")).trim();
          poste = cleanPoste(s.substring(s.indexOf("(")+1, s.lastIndexOf(")")));
        }else{
          name = s;
          poste = "";
        }

        return `
          <div class="staff-row">
            <div class="staff-name">${escapeHtml(name)}</div>
            <div class="staff-poste">${escapeHtml(poste)}</div>
          </div>
        `;
      }).join("");
    }

    function downloadPlanning(){
      /* âœ… capture fond clair */
      html2canvas(document.getElementById("capture-zone"), {
        scale: 2,
        backgroundColor: "#ffffff",
        useCORS: true,
        allowTaint: false
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = "Planning-Service.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      }).catch(() => {
        showAlert("Capture impossible (CORS / images externes).");
      });
    }

    init();
  </script>
</body>
</html>