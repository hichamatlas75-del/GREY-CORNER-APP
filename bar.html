<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planning Bar - Ramadan Kareem</title>
    <link rel="icon" type="image/jpeg" href="LOGO.jpg">
    <meta name="theme-color" content="#1a2a6c"> <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --bg-body: #0f0c29; /* DÃ©gradÃ© nuit profonde */
            --text-color: #2c3e50;
            --gold: #d4af37;
            --emerald: #064e3b;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Roboto', sans-serif; 
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e); 
            background-attachment: fixed;
            margin: 0; padding: 0; 
            color: var(--text-color); 
            padding-bottom: 80px; 
        }
        
        /* HEADER SPECIAL RAMADAN */
        header { 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); /* Coucher de soleil / Ftour */
            padding: 30px 15px 45px; 
            text-align: center; 
            color: white; 
            border-bottom-left-radius: 50px; 
            border-bottom-right-radius: 50px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); 
            margin-bottom: 30px; 
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--gold);
        }

        /* Animation Ã‰toiles & Lune */
        header::before {
            content: 'ðŸŒ™'; position: absolute; top: 15px; left: 20px; font-size: 30px; opacity: 0.7; filter: drop-shadow(0 0 10px gold);
        }
        header::after {
            content: 'âœ¨'; position: absolute; bottom: 20px; right: 30px; font-size: 25px; opacity: 0.5; animation: blink 2s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .logo-img { 
            width: 100px; height: 100px; border-radius: 50%; 
            border: 3px solid var(--gold); object-fit: cover; 
            margin-bottom: 12px; background: #000; 
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); 
        }

        h1 { 
            font-family: 'Playfair Display', serif;
            margin: 0; font-size: 1.8rem; font-weight: 900; 
            letter-spacing: 2px; text-transform: uppercase; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); 
        }
        p.subtitle { margin: 5px 0 0; font-size: 0.95rem; color: #f1c40f; font-weight: 500; font-style: italic; }
        
        #alert-box { 
            display: none; background: linear-gradient(to right, #d4af37, #f1c40f); 
            color: #1a2a6c; text-align: center; padding: 12px; font-weight: 800; 
            position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 0 15px; }
        
        /* CARD STYLE ORIENTAL */
        .day-card { 
            margin-bottom: 30px; 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.4); 
            background: rgba(255, 255, 255, 0.95); 
            border: 1px solid var(--gold);
            transition: transform 0.3s ease;
            position: relative;
        }

        /* Motif en arriÃ¨re-plan discret */
        .day-card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/arabesque.png');
            opacity: 0.05; pointer-events: none;
        }

        .card-header { 
            background-color: var(--theme-header); 
            color: white; padding: 18px; 
            text-align: center; display: flex; flex-direction: column; align-items: center;
            border-bottom: 2px solid var(--gold);
        }
        
        .day-name { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 900; }
        .day-date { font-size: 0.9rem; opacity: 0.9; margin-top: 4px; letter-spacing: 2px; }

        .today-badge {
            background: var(--gold); color: #1a2a6c; 
            font-size: 0.75rem; font-weight: 900; padding: 6px 15px; border-radius: 5px; 
            margin-top: 10px; text-transform: uppercase; animation: pulse-gold 2s infinite;
        }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0px rgba(212, 175, 55, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0px rgba(212, 175, 55, 0); } }
        
        .card-body { padding: 20px; background: white; position: relative; }
        .shift-block { margin-bottom: 25px; }
        
        .shift-header { 
            text-align: center; color: white; font-weight: 700; font-size: 0.9rem; 
            padding: 10px; border-radius: 50px; margin-bottom: 15px; text-transform: uppercase; 
            letter-spacing: 1px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .matin-header { background: linear-gradient(to right, #2c3e50, #4ca1af); } /* Teintes plus douces */
        .soir-header { background: linear-gradient(to right, #1a2a6c, #b21f1f); } /* Teintes Ftour */
        
        .staff-list { display: flex; flex-direction: column; gap: 10px; }
        
        .staff-row { 
            display: flex; align-items: stretch; border: 1px solid #eee;
            border-radius: 12px; overflow: hidden; min-height: 50px; 
        }
        
        .poste-badge { 
            background-color: var(--theme-badge); color: var(--theme-badge-text); 
            font-weight: 900; font-size: 0.7rem; width: 35%; display: flex; align-items: center; justify-content: center; 
            text-transform: uppercase; padding: 5px; text-align: center; border-right: 2px solid var(--gold);
        }
        
        .staff-name { 
            background-color: #fff; color: #1a2a6c; font-weight: 700; font-size: 1rem; 
            width: 65%; display: flex; align-items: center; justify-content: center; 
            text-transform: uppercase;
        }
        
        .back-btn { 
            display: inline-block; margin-top: 18px; color: white; 
            text-decoration: none; font-size: 0.8rem; border: 1.5px solid var(--gold); 
            padding: 8px 20px; border-radius: 50px; background: rgba(0,0,0,0.2);
        }
        
        .is-today { 
            border: 3px solid var(--gold); transform: scale(1.03);
            z-index: 10;
        }

        .fab-btn {
            position: fixed; bottom: 25px; right: 25px; 
            background: radial-gradient(circle, #fdbb2d, #d4af37);
            color: #1a2a6c; width: 65px; height: 65px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 28px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); cursor: pointer; z-index: 100;
            border: 2px solid white; 
        }
        
        #loading { text-align: center; padding: 50px; color: var(--gold); font-size: 1.2rem; }
    </style>
</head>
<body>
    
    <div id="alert-box"></div>
    <div class="fab-btn" onclick="downloadPlanning()" id="dl-btn">ðŸ“¸</div>

    <div id="capture-zone">
        <header>
            <img src="LOGO.jpg" alt="Logo" class="logo-img" onerror="this.src='https://via.placeholder.com/100?text=GC'">
            <h1>RAMADAN KAREEM</h1>
            <p class="subtitle">Planning Ã‰quipe Bar - Grey Corner</p>
            <a href="index.html" class="back-btn" data-html2canvas-ignore="true">â¬… Menu Principal</a>
        </header>

        <div class="container" id="planning-container">
            <div id="loading">âœ¨ PrÃ©paration du planning... âœ¨</div>
        </div>

        <div style="text-align: center; color: rgba(255,255,255,0.5); font-size: 0.7rem; padding: 30px; letter-spacing: 1px;">
            ðŸŒ™ GREY CORNER FÃˆS - RAMADAN 2026 ðŸŒ™
        </div>
    </div>

    <script>
        const SHEET_ID = "1mfwB4zNHS79YsNH4vTMUGOdWeQwC3htMgPtDWsrMbWg";
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

        // --- PALETTES SPÃ‰CIAL RAMADAN ---
        const PALETTES = [
            { header: '#1a2a6c', matin: '#2c3e50', soir: '#b21f1f', badge: '#d4af37', badgeText: '#1a2a6c' }, // Nuit & Or
            { header: '#064e3b', matin: '#065f46', soir: '#d97706', badge: '#fef3c7', badgeText: '#064e3b' }, // Ã‰meraude & Ambre
            { header: '#434343', matin: '#000000', soir: '#c0392b', badge: '#f1c40f', badgeText: '#000' },    // Noir & Rubis
            { header: '#2d3436', matin: '#636e72', soir: '#d63031', badge: '#fab1a0', badgeText: '#2d3436' }  // Ardoise
        ];

        async function init() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                const lines = text.split('\n');

                if(lines.length > 1) {
                    const row2 = lines[1].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if(row2.length >= 4) {
                        let message = row2[3].replace(/^"|"$/g, '').trim();
                        if(message) { 
                            const alertBox = document.getElementById('alert-box');
                            alertBox.innerHTML = "ðŸŒ™ " + message; 
                            alertBox.style.display = 'block';
                            document.body.classList.add('has-alert');
                        }
                    }
                }

                document.getElementById('loading').style.display = 'none';
                renderPlanning(parseCSV(text));

            } catch (error) { 
                console.error(error); 
                document.getElementById('loading').innerHTML = "Erreur de chargement."; 
            }
        }

        function parseDateFr(dateStr) {
            if(!dateStr) return null;
            let cleanStr = dateStr.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\./g, "").trim();
            const jours = ["lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi", "dimanche"];
            jours.forEach(j => cleanStr = cleanStr.replace(j, ""));
            let dayMatch = cleanStr.match(/(\d+)/);
            if (!dayMatch) return null;
            let day = parseInt(dayMatch[0]);
            let month = -1;
            const monthsShort = ['jan', 'fev', 'mar', 'avr', 'mai', 'jui', 'jul', 'aou', 'sep', 'oct', 'nov', 'dec'];
            for (let i = 0; i < monthsShort.length; i++) { if (cleanStr.includes(monthsShort[i])) { month = i; break; } }
            if (month === -1) return null;
            let now = new Date(); let year = now.getFullYear();
            return new Date(year, month, day);
        }

        function parseCSV(text) {
            const rows = text.split('\n').map(r => r.trim()).filter(r => r);
            const result = [];
            for (let i = 0; i < rows.length; i++) {
                const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length < 3) continue;
                if (cols[0].toUpperCase().includes("DATE") || !cols[0]) continue;
                result.push({ date: cols[0], matin: cols[1], soir: cols[2] });
            }
            return result;
        }

        function renderPlanning(data) {
            const container = document.getElementById('planning-container');
            container.innerHTML = '';
            const now = new Date();
            const jourSemaine = now.toLocaleDateString('fr-FR', { weekday: 'long' }).toLowerCase();
            const jourNumero = now.getDate();
            const cutoffDate = new Date(); cutoffDate.setDate(now.getDate() - 2); cutoffDate.setHours(0,0,0,0);

            let currentWeekIndex = 0;
            let firstDay = true;

            data.forEach((jour) => {
                let jourDateObj = parseDateFr(jour.date);
                if (jourDateObj && jourDateObj < cutoffDate) { return; }
                if (jour.date.toLowerCase().includes("lundi") && !firstDay) { currentWeekIndex++; }
                firstDay = false;

                const theme = PALETTES[currentWeekIndex % PALETTES.length];
                let isTodayClass = (jour.date.toLowerCase().includes(jourSemaine) && jour.date.includes(jourNumero)) ? 'is-today' : '';
                let todayBadgeHTML = isTodayClass ? '<div class="today-badge">Saha Ftourkoum</div>' : '';

                let splitDate = jour.date.split(' ');
                const styleVars = `--theme-header: ${theme.header}; --theme-matin: ${theme.matin}; --theme-soir: ${theme.soir}; --theme-badge: ${theme.badge}; --theme-badge-text: ${theme.badgeText};`;

                container.innerHTML += `
                    <div class="day-card ${isTodayClass}" style="${styleVars}">
                        <div class="card-header">
                            <span class="day-name">${splitDate[0]}</span>
                            <span class="day-date">${splitDate.slice(1).join(' ')}</span>
                            ${todayBadgeHTML}
                        </div>
                        <div class="card-body">
                            <div class="shift-block">
                                <div class="shift-header matin-header">Service Matin</div>
                                <div class="staff-list">${parseStaff(jour.matin)}</div>
                            </div>
                            <div class="shift-block">
                                <div class="shift-header soir-header">Service Ftour / Soir</div>
                                <div class="staff-list">${parseStaff(jour.soir)}</div>
                            </div>
                        </div>
                    </div>`;
            });

            setTimeout(() => { 
                const t = document.querySelector('.is-today'); 
                if(t) { t.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
            }, 600);
        }

        function parseStaff(text) {
            if (!text || text === '-' || text === '') return '<div style="padding:10px; text-align:center; color:#bbb; font-size:0.8rem;">Repos</div>';
            return text.split(',').map(s => {
                let entry = s.trim();
                let nom = entry, poste = "BAR";
                const matchParens = entry.match(/^(.*?)\s*\((.*?)\)$/);
                if (matchParens) { nom = matchParens[1]; poste = matchParens[2]; }
                else if (entry.includes(':')) { let p = entry.split(':'); poste = p[0]; nom = p[1]; }
                return `<div class="staff-row"><div class="poste-badge">${poste}</div><div class="staff-name">${nom}</div></div>`;
            }).join('');
        }

        function downloadPlanning() {
            const element = document.getElementById("capture-zone");
            const btn = document.getElementById("dl-btn");
            btn.innerText = "â³";
            html2canvas(element, { scale: 2, backgroundColor: "#0f0c29" }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Planning-Ramadan-Bar.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                btn.innerText = "ðŸ“¸";
            });
        }
        init();
    </script>
</body>
</html>
