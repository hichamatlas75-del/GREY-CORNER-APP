<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Planning Bar - Grey Corner</title>
  <link rel="icon" type="image/jpeg" href="LOGO.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root { --gold:#D4AF37; --night:#0B0E14; --card-bg:#1A1F26; }

    body{
      font-family:'Roboto',sans-serif;
      background: radial-gradient(circle at top,#1a2a6c 0%, var(--night) 100%);
      background-attachment: fixed;
      margin:0; color:#fff; padding-bottom:80px;
      overflow-x:hidden; -webkit-overflow-scrolling: touch;
    }

    /* ‚úÖ BANNI√àRE FIXE (TOUJOURS VISIBLE) */
    #alert-box{
      display:none;
      background: linear-gradient(to right, #d4af37, #f1c40f);
      color:#000;
      text-align:center;
      padding:12px 48px 12px 12px;
      font-weight:900;
      position:fixed; top:0; left:0; width:100%;
      z-index:9999;
      box-shadow: 0 8px 22px rgba(0,0,0,0.35);
    }
    body.has-alert{ padding-top:52px; }

    #alert-close{
      position:absolute;
      right:10px;
      top:50%;
      transform: translateY(-50%);
      border:none;
      background: rgba(0,0,0,0.18);
      color:#000;
      font-weight:900;
      width:30px; height:30px;
      border-radius: 999px;
      cursor:pointer;
    }

    header{
      padding:40px 15px; text-align:center; border-bottom:2px solid var(--gold);
      background: rgba(0,0,0,0.2);
    }
    .logo-img{ width:85px; height:85px; border-radius:50%; border:2px solid var(--gold); margin-bottom:10px; }
    h1{ font-family:'Playfair Display',serif; margin:0; font-size:1.5rem; color:var(--gold); letter-spacing:2px; text-transform:uppercase; }

    .container{ width:100%; max-width:500px; margin:0 auto; padding:20px 15px; }

    .day-card{
      background:var(--card-bg); margin-bottom:25px; border-radius:15px;
      border:1px solid rgba(212,175,55,0.2); overflow:hidden;
      scroll-margin-top: 0; /* banni√®re fixe */
    }

    .card-header{ background: rgba(255,255,255,0.03); padding:15px; text-align:center; border-bottom:1px solid rgba(212,175,55,0.1); }
    .day-name{ font-family:'Playfair Display',serif; font-size:1.4rem; color:var(--gold); display:block; text-transform:capitalize; }
    .today-badge{
      background: var(--gold); color:#000; font-size:0.7rem; font-weight:900;
      padding:4px 12px; border-radius:4px; margin-top:8px; display:inline-block;
    }
    .is-today{ border:2px solid var(--gold); box-shadow:0 5px 20px rgba(212,175,55,0.2); }

    .card-body{ padding:15px; }
    .shift-header{
      color:var(--gold); font-size:0.8rem; font-weight:bold; text-align:center;
      padding:8px; border:1px solid rgba(212,175,55,0.2); border-radius:5px; margin-bottom:10px;
      background: rgba(212,175,55,0.05); text-transform:uppercase;
    }

    .staff-row{ display:flex; margin-bottom:8px; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.05); }
    .poste-badge{ background:var(--gold); color:#000; width:35%; padding:10px; font-size:0.65rem; font-weight:900; text-align:center; display:flex; align-items:center; justify-content:center; }
    .staff-name{ background:rgba(255,255,255,0.08); color:#fff; width:65%; padding:10px; font-weight:bold; text-align:center; text-transform:uppercase; font-size:0.9rem; }

    .fab-btn{
      position:fixed; bottom:20px; right:20px; background:var(--gold);
      width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      box-shadow:0 5px 20px rgba(0,0,0,0.5); font-size:24px; cursor:pointer; z-index:100; border:none;
    }

    .back-btn{ display:inline-block; margin-top:15px; color:var(--gold); text-decoration:none; font-size:0.8rem; border:1px solid var(--gold); padding:8px 15px; border-radius:20px; }
    #loading{ text-align:center; padding:50px; color:var(--gold); font-family:'Playfair Display',serif; }
  </style>
</head>

<body>
  <div id="alert-box">
    <span id="alert-text"></span>
    <button id="alert-close" type="button" onclick="hideAlert()">‚úï</button>
  </div>

  <button class="fab-btn" onclick="downloadPlanning()">üì∏</button>

  <div id="capture-zone">
    <header>
      <img src="LOGO.jpg" class="logo-img" onerror="this.src='https://via.placeholder.com/90?text=GC'">
      <h1>PLANNING BAR</h1>
      <a href="index.html" class="back-btn" data-html2canvas-ignore="true">‚¨Ö Retour Menu</a>
    </header>

    <div class="container" id="planning-container">
      <div id="loading">Pr√©paration du comptoir...</div>
    </div>
  </div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1mfwB4zNHS79YsNH4vTMUGOdWeQwC3htMgPtDWsrMbWg/gviz/tq?tqx=out:csv&gid=294813093";

    function showAlert(msg){
      const box = document.getElementById("alert-box");
      const textEl = document.getElementById("alert-text");
      if(!box || !textEl) return;
      textEl.textContent = msg;
      box.style.display = "block";
      document.body.classList.add("has-alert");
      /* ‚úÖ pas de setTimeout => ne dispara√Æt pas */
    }

    function hideAlert(){
      const box = document.getElementById("alert-box");
      if(!box) return;
      box.style.display = "none";
      document.body.classList.remove("has-alert");
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function isHtml(text){
      return /<html[\s>]/i.test(text) || /<!doctype html/i.test(text);
    }

    function normalize(str){
      return String(str ?? "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ")
        .trim();
    }

    function splitCsvLine(line){
      return line
        .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
        .map(c => c.replace(/^"|"$/g, '').trim());
    }

    function getTodayInfo(){
      const now = new Date();
      const day = now.getDate();
      const weekday = normalize(new Intl.DateTimeFormat("fr-FR", { weekday:"long" }).format(now));
      const month   = normalize(new Intl.DateTimeFormat("fr-FR", { month:"long" }).format(now));
      return { day, weekday, month };
    }

    function rowLooksLikeToday(label, todayInfo){
      const s = normalize(label);
      if(!s) return false;
      const hasDayNum = new RegExp(`\\b${todayInfo.day}\\b`).test(s);
      if(!hasDayNum) return false;
      return s.includes(todayInfo.weekday) || s.includes(todayInfo.month);
    }

    function cleanPoste(raw){
      if(!raw) return "";
      const p = String(raw).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();

      if(p.includes("loge")) return "LOGE";
      if(p.includes("ter1")) return "TER1";
      if(p.includes("ter2")) return "TER2";
      if(p.includes("ter3")) return "TER3";
      if(p.includes("terrasse") || p.includes("ter")) return "TER";
      if(p.includes("sala2")) return "SAL2";
      if(p.includes("sala1") || p.includes("sala") || p === "sal") return "SAL";
      if(p.includes("bar")) return "BAR";
      if(p.includes("caisse")) return "CAIS";
      if(p.includes("run")) return "RUN";
      if(p.includes("acc")) return "ACC";
      if(p.includes("deb")) return "DEB";

      return String(raw).substring(0,4).toUpperCase();
    }

    async function init(){
      const loadingEl = document.getElementById("loading");
      try{
        const resp = await fetch(SHEET_URL, { cache:"no-store" });
        const text = await resp.text();

        if(isHtml(text)){
          if(loadingEl) loadingEl.innerText = "Acc√®s refus√© (pas de CSV).";
          showAlert("G√©rer l‚Äôacc√®s ‚Üí Toute personne avec le lien (Lecteur).");
          return;
        }

        const rows = text.split(/\r?\n/).map(r => r.trim()).filter(r => r);
        if(rows.length <= 1){
          if(loadingEl) loadingEl.innerText = "CSV vide / onglet vide.";
          return;
        }

        const todayInfo = getTodayInfo();

        /* ‚úÖ M√äME LOGIQUE QUE SERVICE : BANNI√àRE FIXE = D2 */
        let bannerD2 = "";
        if (rows.length >= 2) {
          const colsRow2 = splitCsvLine(rows[1]);      // rows[0]=header, rows[1]=ligne 2
          bannerD2 = String(colsRow2[3] ?? "").trim(); // colonne D
        }
        if (bannerD2 && bannerD2 !== "-") showAlert(bannerD2);

        const all = [];
        for(let i=1;i<rows.length;i++){
          const cols = splitCsvLine(rows[i]);
          if(cols.length >= 3 && cols[0]){
            all.push({ date: cols[0], matin: cols[1] ?? "", soir: cols[2] ?? "" });
          }
        }

        const startIndex = all.findIndex(r => rowLooksLikeToday(r.date, todayInfo));
        const hasToday = startIndex >= 0;
        const data = hasToday ? all.slice(startIndex) : all;

        if(!hasToday && !bannerD2){
          showAlert("Aujourd'hui non trouv√© (format date diff√©rent).");
        }

        renderPlanning(data, hasToday);

      }catch(e){
        if(loadingEl) loadingEl.innerText = "Erreur r√©seau / CORS.";
        showAlert("Si la page est ouverte en file://, h√©berge-la en HTTPS (Firebase/Netlify).");
      }
    }

    function renderPlanning(data, hasToday){
      const container = document.getElementById("planning-container");
      const loadingEl = document.getElementById("loading");
      if(loadingEl) loadingEl.remove();

      if(!data.length){
        container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--gold);">Aucune donn√©e</div>`;
        return;
      }

      container.innerHTML = data.map((jour, idx) => {
        const isToday = hasToday && idx === 0;
        return `
          <div class="day-card ${isToday ? 'is-today' : ''}" ${isToday ? 'id="today-card"' : ''}>
            <div class="card-header">
              <span class="day-name">${escapeHtml(jour.date)}</span>
              ${isToday ? `<div class="today-badge">AUJOURD'HUI</div>` : ``}
            </div>
            <div class="card-body">
              <div class="shift-header">MATIN</div>
              ${parseStaff(jour.matin)}
              <div class="shift-header" style="margin-top:20px;">SOIR</div>
              ${parseStaff(jour.soir)}
            </div>
          </div>
        `;
      }).join("");

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const el = document.getElementById("today-card");
          if(el) el.scrollIntoView({ behavior:"smooth", block:"center" });
        });
      });
    }

    function parseStaff(text){
      if(!text || text === '-' || text.trim() === ''){
        return '<div style="text-align:center; opacity:0.3; font-size:0.8rem; padding:10px;">REPOS</div>';
      }

      return text.split(',').map(s => {
        s = s.trim();
        let nom = "";
        let poste = "BAR";

        if(s.includes(':')){
          const p = s.split(':');
          poste = cleanPoste((p[0] || '').trim()) || "BAR";
          nom = (p.slice(1).join(':') || '').trim();
        }else if(s.includes('(') && s.includes(')')){
          nom = s.substring(0, s.indexOf('(')).trim();
          poste = cleanPoste(s.substring(s.indexOf('(')+1, s.lastIndexOf(')'))) || "BAR";
        }else{
          nom = s.trim();
          poste = "BAR";
        }

        return `<div class="staff-row">
          <div class="poste-badge">${escapeHtml(poste)}</div>
          <div class="staff-name">${escapeHtml(nom)}</div>
        </div>`;
      }).join('');
    }

    function downloadPlanning(){
      html2canvas(document.getElementById("capture-zone"), {
        scale: 2,
        backgroundColor: "#0B0E14",
        useCORS: true,
        allowTaint: false
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'Planning-Bar.png';
        link.href = canvas.toDataURL("image/png");
        link.click();
      }).catch(() => showAlert("Capture impossible (CORS / images externes)."));
    }

    init();
  </script>
</body>
</html>